name: ðŸ—ï¸ Complete CI/CD Pipeline

on:
  pull_request:
    branches:
      - developer
      - develop
    types: [opened, synchronize, reopened]
    paths:
      - "src/core/**"
      - "tests/**"

  push:
    branches:
      - developer
      - develop
    paths:
      - "src/core/**"

  # Permitir ejecuciÃ³n manual
  workflow_dispatch:
    inputs:
      debug:
        description: "Enable debug mode"
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: "18"

jobs:
  structure-validation:
    name: ðŸ” Validate Core Structure
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Necesario para comparar cambios

      - name: ðŸ·ï¸ Extract Branch Info
        id: branch-info
        run: |
          SOURCE_BRANCH="${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}"
          echo "source_branch=$SOURCE_BRANCH" >> $GITHUB_OUTPUT
          echo "target_branch=${GITHUB_BASE_REF:-developer}" >> $GITHUB_OUTPUT

          # Identificar tipo de rama
          case "$SOURCE_BRANCH" in
            feature/*|feat/*|bugfix/*|hotfix/*)
              echo "is_valid_branch_type=true" >> $GITHUB_OUTPUT
              echo "branch_type=${SOURCE_BRANCH%%/*}" >> $GITHUB_OUTPUT
              ;;
            developer|develop|main)
              echo "is_valid_branch_type=true" >> $GITHUB_OUTPUT
              echo "branch_type=core" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "is_valid_branch_type=false" >> $GITHUB_OUTPUT
              echo "branch_type=unknown" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: ðŸ“ˆ Show Branch Information
        run: |
          echo "ðŸŒ¿ Source Branch: ${{ steps.branch-info.outputs.source_branch }}"
          echo "ðŸŽ¯ Target Branch: ${{ steps.branch-info.outputs.target_branch }}"
          echo "ðŸ·ï¸ Branch Type: ${{ steps.branch-info.outputs.branch_type }}"
          echo "âœ… Valid Branch Type: ${{ steps.branch-info.outputs.is_valid_branch_type }}"

      - name: âš¡ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ðŸ”§ Install Dependencies
        run: |
          echo "ðŸ“¦ Installing dependencies..."
          npm ci --prefer-offline --no-audit

      - name: ðŸ” TypeScript Validation
        id: typescript-check
        run: |
          echo "ðŸ” Validando tipos TypeScript..."
          npx tsc --noEmit
        continue-on-error: true

      - name: ðŸ§ª Run Structure Tests
        id: structure-tests
        run: |
          echo "ðŸ” Ejecutando tests de validaciÃ³n de estructura..."
          npm run test:structure
        continue-on-error: true

      - name: ðŸ“‹ Generate Structure Report
        run: |
          echo "ðŸ“Š Generando reporte de estructura..."
          npm run test:ci || echo "âš ï¸ Tests fallaron, pero continuamos para generar reporte"

      - name: ðŸ“¤ Upload Structure Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: structure-validation-report
          path: |
            structure-report.json
            test-results.xml
          retention-days: 30

      - name: ðŸ” Analyze Structure Changes
        if: github.event_name == 'pull_request'
        run: |
          echo "ðŸ” Analizando cambios en estructura..."

          # Verificar si hay cambios en la estructura core
          CORE_CHANGES=$(git diff --name-only origin/${{ steps.branch-info.outputs.target_branch }}...HEAD | grep '^src/core/' || echo "")

          if [ -n "$CORE_CHANGES" ]; then
            echo "ðŸ“ Cambios detectados en src/core/:"
            echo "$CORE_CHANGES"
            echo "core_changes=true" >> $GITHUB_ENV
          else
            echo "âœ… No hay cambios en src/core/"
            echo "core_changes=false" >> $GITHUB_ENV
          fi

      - name: âœ… Validate Branch Flow
        if: github.event_name == 'pull_request'
        run: |
          echo "ðŸ”§ Validando flujo de ramas..."
          echo "ðŸŒ¿ Source: ${{ steps.branch-info.outputs.source_branch }}"
          echo "ðŸŽ¯ Target: ${{ steps.branch-info.outputs.target_branch }}"

          SOURCE="${{ steps.branch-info.outputs.source_branch }}"
          TARGET="${{ steps.branch-info.outputs.target_branch }}"

          # Solo permitir developer -> main
          if [ "$TARGET" == "main" ] && [ "$SOURCE" != "developer" ]; then
            echo "âŒ ERROR: Solo la rama 'developer' puede hacer PR hacia 'main'"
            echo "   Rama origen actual: $SOURCE"
            exit 1
          fi

          # Para developer/develop, validar tipos de rama permitidos
          if [ "$TARGET" == "developer" ] || [ "$TARGET" == "develop" ]; then
            case "$SOURCE" in
              feature/*|feat/*|bugfix/*|hotfix/*)
                echo "âœ… Tipo de rama vÃ¡lido: $SOURCE -> $TARGET"
                ;;
              developer|develop)
                echo "âœ… Rama core vÃ¡lida: $SOURCE -> $TARGET"
                ;;
              *)
                echo "âŒ ERROR: Solo se permiten ramas feature/*, feat/*, bugfix/*, hotfix/* hacia developer/develop"
                echo "   Rama origen actual: $SOURCE"
                echo "   Tipos permitidos: feature/*, feat/*, bugfix/*, hotfix/*"
                exit 1
                ;;
            esac
          elif [ "$SOURCE" == "developer" ] && [ "$TARGET" == "main" ]; then
            echo "âœ… Developer -> main: VÃLIDO"
          else
            echo "âœ… Flujo de rama vÃ¡lido para otros casos"
          fi
          fi

      - name: ðŸŽ¯ Final Validation
        run: |
          echo "ðŸŽ¯ ValidaciÃ³n final completa..."

          # Verificar TypeScript primero
          if [ "${{ steps.typescript-check.outcome }}" != "success" ]; then
            echo "âŒ Los tipos TypeScript fallaron. Re-ejecutando para obtener detalles..."
            npx tsc --noEmit || {
              echo "ðŸ’¥ ERRORES DE TYPESCRIPT - El PR no puede ser aprobado"
              echo "ðŸ“‹ Revisa los errores de tipos arriba"
              exit 1
            }
          fi

          # Re-ejecutar tests si fallaron antes
          if [ "${{ steps.structure-tests.outcome }}" != "success" ]; then
            echo "âŒ Los tests de estructura fallaron. Re-ejecutando para obtener detalles..."
            npm run test:structure || {
              echo "ðŸ’¥ ESTRUCTURA INVÃLIDA - El PR no puede ser aprobado"
              echo "ðŸ“‹ Revisa los errores de estructura arriba"
              exit 1
            }
          fi

          echo "âœ… ValidaciÃ³n completa exitosa - PR puede ser aprobado"

      - name: ðŸ’¬ Comment on PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const success = '${{ steps.structure-tests.outcome }}' === 'success';
            const coreChanges = process.env.core_changes === 'true';

            let comment = `## ðŸ—ï¸ Structure Validation Report\n\n`;

            if (success) {
              comment += `âœ… **Structure validation passed!**\n\n`;
            } else {
              comment += `âŒ **Structure validation failed!**\n\n`;
            }

            comment += `ðŸ“Š **Details:**\n`;
            comment += `- Source: \`${{ steps.branch-info.outputs.source_branch }}\`\n`;
            comment += `- Target: \`${{ steps.branch-info.outputs.target_branch }}\`\n`;
            comment += `- Core changes: ${coreChanges ? 'âœ… Yes' : 'âŒ No'}\n`;

            if (!success) {
              comment += `\nâš ï¸ **Action required:** Please fix the structure issues before merging.\n`;
              comment += `ðŸ“‹ Check the "Structure Validation" job details for specific errors.\n`;
            }

            comment += `\nðŸ”— [View full report in Actions](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: ðŸ“ˆ Set Status Check
        if: always()
        run: |
          if [ "${{ steps.typescript-check.outcome }}" == "success" ] && [ "${{ steps.structure-tests.outcome }}" == "success" ]; then
            echo "âœ… All validations passed"
            echo "VALIDATION_STATUS=success" >> $GITHUB_ENV
          else
            echo "âŒ Validation failed"  
            if [ "${{ steps.typescript-check.outcome }}" != "success" ]; then
              echo "âŒ TypeScript validation failed"
            fi
            if [ "${{ steps.structure-tests.outcome }}" != "success" ]; then
              echo "âŒ Structure validation failed"
            fi
            echo "VALIDATION_STATUS=failure" >> $GITHUB_ENV
            exit 1
          fi
